<%= form_with(model: article, local: true, class: "article-form") do |form| %>
  <% if article.errors.any? %>
    <div class="error-messages">
      <h4><%= pluralize(article.errors.count, "error") %> prohibited this article from being saved:</h4>
      <ul>
        <% article.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="form-group">
    <%= form.label :image, class: "form-label" %>
    <%= form.file_field :image, class: "form-input", accept: "image/*" %>
    <small class="form-help">Optional: Add an image to your article (JPEG, PNG, GIF, or WebP, max 10MB)</small>
    
    <% if article.image.attached? %>
      <div class="current-image">
        <p>Current image:</p>
        <%= image_tag article.image, class: "image-preview" %>
        <p><small>Upload a new image to replace this one</small></p>
      </div>
    <% end %>
  </div>

  <div class="form-group">
    <%= form.label :title, class: "form-label" %>
    <%= form.text_field :title, class: "form-input", placeholder: "Enter article title..." %>
  </div>

  <div class="form-group">
    <%= form.label :category, class: "form-label" %>
    <%= form.text_field :category, class: "form-input", placeholder: "e.g., House Rules, Session Report, Character Guide..." %>
    <small class="form-help">Optional: Choose a category to help organize your articles</small>
  </div>

  <div class="form-group">
    <%= form.label :tags, class: "form-label" %>
    <div class="tags-input-container">
      <input type="text" 
             id="tags-input" 
             class="form-input" 
             placeholder="Type tags and press Enter (e.g., combat, beginner, magic...)"
             data-tags="<%= article.tags.join(',') if article.tags.any? %>">
      <div id="tags-display" class="tags-display"></div>
    </div>
    <small class="form-help">Add tags to help categorize your article. Type a tag and press Enter.</small>
    
    <!-- Hidden inputs for tags -->
    <div id="tags-hidden-inputs">
      <% if article.tags.any? %>
        <% article.tags.each do |tag| %>
          <%= hidden_field_tag "article[tags][]", tag %>
        <% end %>
      <% end %>
    </div>
  </div>

  <div class="form-group">
    <%= form.label :content, class: "form-label" %>
    <%= form.text_area :content, class: "form-textarea", rows: 15, 
                       placeholder: "Write your article content here... You can use **bold** and *italic* markdown." %>
    <small class="form-help">Markdown supported: **bold**, *italic*</small>
  </div>

  <div class="form-actions">
    <%= form.submit class: "btn btn-primary" %>
    <%= link_to "Cancel", article_path(article), class: "btn btn-secondary" if article.persisted? %>
    <%= link_to "Cancel", articles_path, class: "btn btn-secondary" unless article.persisted? %>
  </div>
<% end %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const tagsInput = document.getElementById('tags-input');
  const tagsDisplay = document.getElementById('tags-display');
  const hiddenInputsContainer = document.getElementById('tags-hidden-inputs');
  
  let tags = [];
  
  // Initialize with existing tags
  const existingTags = tagsInput.dataset.tags;
  if (existingTags) {
    tags = existingTags.split(',').filter(tag => tag.trim() !== '');
    updateTagsDisplay();
  }
  
  tagsInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      const tag = this.value.trim();
      if (tag && !tags.includes(tag)) {
        tags.push(tag);
        updateTagsDisplay();
        this.value = '';
      }
    }
  });
  
  function updateTagsDisplay() {
    // Update visual display
    tagsDisplay.innerHTML = tags.map(tag => 
      `<span class="tag-item">
         ${tag}
         <button type="button" class="tag-remove" data-tag="${tag}">Ã—</button>
       </span>`
    ).join('');
    
    // Update hidden inputs
    hiddenInputsContainer.innerHTML = tags.map(tag => 
      `<input type="hidden" name="article[tags][]" value="${tag}">`
    ).join('');
    
    // Add event listeners to remove buttons
    document.querySelectorAll('.tag-remove').forEach(button => {
      button.addEventListener('click', function() {
        const tagToRemove = this.dataset.tag;
        tags = tags.filter(tag => tag !== tagToRemove);
        updateTagsDisplay();
      });
    });
  }
});
</script>

<style>
  body {
    background: #1a1a1a;
    color: #c0c0c0;
    font-family: 'Courier New', monospace;
  }

  .article-form {
    max-width: 800px;
    margin: 0 auto;
    background: #2a2a2a;
    padding: 25px;
    border: 2px solid #4a4a4a;
    border-radius: 8px;
    border-bottom: 3px solid #8b4513;
  }

  .error-messages {
    background: #3a2a2a;
    color: #ff6b6b;
    padding: 15px;
    border-radius: 4px;
    border: 2px solid #8b2635;
    margin-bottom: 20px;
  }

  .error-messages h4 {
    margin: 0 0 12px 0;
    font-size: 1em;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .error-messages ul {
    margin: 0;
    padding-left: 20px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: #cd853f;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 0.9em;
  }

  .form-input {
    width: 100%;
    padding: 12px;
    border: 2px solid #4a4a4a;
    border-radius: 4px;
    font-size: 1em;
    background: #1a1a1a;
    color: #c0c0c0;
    font-family: 'Courier New', monospace;
  }

  .form-input:focus {
    outline: none;
    border-color: #8b4513;
    box-shadow: 0 0 8px rgba(139, 69, 19, 0.3);
  }

  .form-textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid #4a4a4a;
    border-radius: 4px;
    font-size: 1em;
    font-family: 'Courier New', monospace;
    line-height: 1.5;
    resize: vertical;
    background: #1a1a1a;
    color: #c0c0c0;
  }

  .form-textarea:focus {
    outline: none;
    border-color: #8b4513;
    box-shadow: 0 0 8px rgba(139, 69, 19, 0.3);
  }

  .form-help {
    display: block;
    margin-top: 6px;
    color: #888;
    font-size: 0.85em;
    font-style: italic;
  }

  .tags-input-container {
    position: relative;
  }

  .tags-display {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 12px;
  }

  .tag-item {
    background: #3a3a3a;
    color: #c0c0c0;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.8em;
    border: 1px solid #555;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .tag-remove {
    background: none;
    border: none;
    color: #888;
    cursor: pointer;
    font-size: 1.1em;
    line-height: 1;
    padding: 0;
    width: 14px;
    height: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .tag-remove:hover {
    color: #ff6b6b;
  }

  .form-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    padding-top: 20px;
    border-top: 2px solid #4a4a4a;
  }

  .btn {
    padding: 10px 18px;
    border-radius: 4px;
    text-decoration: none;
    font-size: 0.9em;
    border: 2px solid;
    cursor: pointer;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-family: 'Courier New', monospace;
  }

  .btn-primary {
    background: #8b4513;
    color: #ffffff;
    border-color: #654321;
  }

  .btn-primary:hover {
    background: #a0522d;
  }

  .btn-secondary {
    background: #4a4a4a;
    color: #c0c0c0;
    border-color: #555;
  }

  .btn-secondary:hover {
    background: #555;
  }

  .current-image {
    margin-top: 15px;
    padding: 15px;
    background: #3a3a3a;
    border-radius: 4px;
    border: 2px solid #4a4a4a;
  }

  .current-image p {
    margin: 0 0 12px 0;
    color: #c0c0c0;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 0.9em;
  }

  .image-preview {
    max-width: 300px;
    max-height: 200px;
    border-radius: 4px;
    border: 2px solid #4a4a4a;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .article-form {
      margin: 10px;
      padding: 20px;
    }
    
    .form-actions {
      flex-direction: column;
    }
    
    .btn {
      width: 100%;
      text-align: center;
    }
  }
</style>